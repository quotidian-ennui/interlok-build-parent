name: owasp
on:
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - "serviceTestLog4j2.xml"
      - "verifyLog4j2.xml"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "README.md"
      - "serviceTestLog4j2.xml"
      - "verifyLog4j2.xml"
  schedule:
    - cron: "15 03 * * SUN"
env:
  GRADLE_VERSION: 8.5
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions: {}
jobs:
  owasp:
    name: OWASP Dependency Check Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Set up JDK
        uses: actions/setup-java@387ac29b308b003ca37ba93a6cab5eb57c8f5f93 # v4.0.0
        with:
          java-version: 21
          distribution: "temurin"
      - name: Setup Ubuntu
        id: ubuntu-bootstrap
        run: |
          echo "today=$(/bin/date -u '+%Y%m%d')" >> "$GITHUB_OUTPUT"
      - name: Setup Gradle
        uses: gradle/gradle-build-action@982da8e78c05368c70dac0351bb82647a9e9a5d2 # v2.11.1
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}
          gradle-home-cache-excludes: dependency-check-data
      - name: OWASP dependency-check-data cache
        uses: actions/cache@e12d46a63a90f2fae62d114769bbf2a179198b5c # v3.3.3
        with:
          path: ~/.gradle/dependency-check-data
          key: ${{ runner.os }}-dependency-check-data-${{ steps.ubuntu-bootstrap.outputs.today }}
          restore-keys: |
            ${{ runner.os }}-dependency-check-data-
      - name: Gradle DependencyCheckAnalyze
        uses: gradle/gradle-build-action@982da8e78c05368c70dac0351bb82647a9e9a5d2 # v2.11.1
        id: owasp
        env:
          JAVA_TOOL_OPTIONS: -Dpolyglot.js.nashorn-compat=true -Dpolyglot.engine.WarnInterpreterOnly=false
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}
          arguments: dependencyCheckAnalyze
          build-root-directory: test
      - name: Update PR
        id: comment
        uses: quotidian-ennui/actions-olio/pr-or-issue-comment@376801a8682f63c943378e72e1fa752400709bf1 # main
        if: |
          (success() || failure()) &&
          github.event_name == 'pull_request' &&
          github.event.pull_request.number != ''
        with:
          issue_number: ${{ github.event.pull_request.number }}
          body: |
            OWASP Dependency Check: ${{ steps.owasp.outcome }}

            [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          search_term: "dependabot-action-dependency-check-analyze"
          token: ${{ github.token }}
